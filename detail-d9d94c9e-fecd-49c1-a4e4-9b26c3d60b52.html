<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Detail</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1>Script Detail</h1>
      <button id="backButton" class="back-button">← Back</button>
    </header>

    <main id="detailContent">
      <h2 id="detailTitle">证道伏魔录·辅助</h2>

      
        <p><strong>namespace:</strong> Violentmonkey Scripts</p>
      
        <p><strong>match:</strong> https://fml.alangge.com/*</p>
      
        <p><strong>grant:</strong> none</p>
      
        <p><strong>version:</strong> 1.1</p>
      
        <p><strong>author:</strong> 六记</p>
      
        <p><strong>description:</strong> 证道伏魔录游戏辅助功能增强，支持一键操作等自动化脚本</p>
      
        <p><strong>id:</strong> d9d94c9e-fecd-49c1-a4e4-9b26c3d60b52</p>
      
        <p><strong>filePath:</strong> scripts/证道伏魔录·辅助.user.js</p>
      
        <p><strong>downloadLink:</strong> https://raw.githubusercontent.com/ACG-Q/UserScript/main/scripts/证道伏魔录·辅助.user.js</p>
      

      <p><strong>content:</strong></p>
      <pre>// ==UserScript==
// @name         证道伏魔录·辅助
// @namespace    Violentmonkey Scripts
// @match        https://fml.alangge.com/*
// @grant        none
// @version      1.1
// @author       六记
// @description  证道伏魔录游戏辅助功能增强，支持一键操作等自动化脚本
// ==/UserScript==

(() =&gt; {
  const wait = (milliseconds) =&gt; {
    return new Promise((resolve) =&gt; {
      setTimeout(resolve, milliseconds);
    });
  };

  // 一键关闭秘境
  const addOneCloseButton = () =&gt; {
    //判断是否在“外事堂”
    let title = document.querySelector(&#34;.button_tz_post.nav-hover&#34;);
    let buttonGroup = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div:nth-child(4) &gt; div &gt; div.col-md-12.col-xs-12 &gt; div:nth-child(4)&#34;,
    );
    if (
      title &amp;&amp;
      title.innerText === &#34;外事堂&#34; &amp;&amp;
      !document.querySelector(&#34;#sp_for&#34;)
    ) {
      // 如果存在说明是在秘境中
      if (buttonGroup) {
        return false;
      }
      const toolbar = document.querySelectorAll(&#34;.body_sm&gt;div&gt;div&#34;)[3];
      // 添加 一键关闭(非VIP)
      // &lt;input type=&#34;button&#34; class=&#34;button3 button_submit&#34; url=&#34;menu=dfws&#34; name=&#34;onekeyclosesecret&#34; value=&#34;一键关闭&#34;&gt;
      const button = document.createElement(&#34;input&#34;);
      button.type = &#34;button&#34;;
      button.classList = &#34;button3 button_submit&#34;;
      button.value = &#34;一键关闭(非VIP)&#34;;
      button.id = &#34;sp_for&#34;;
      button.onclick = () =&gt; {
        // eslint-disable-next-line no-restricted-globals
        if (confirm(&#34;您确定要进行一键关闭吗？&#34;)) {
          document
            .querySelectorAll(&#34;.text-nowrap&#34;)[1]
            .querySelectorAll(&#34;.button9&#34;)
            .forEach((e) =&gt; e.click());
          window.location.reload();
        }
      };

      toolbar.appendChild(button);

      return true;
    }
    return false;
  };

  // 一键签到 &amp; 领取VIP等级福利 &amp; 无尽深渊
  const addOneSignButton = () =&gt; {
    const getWj = () =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let url = &#34;/index.php?Wjsy&#34;;
        let params = new URLSearchParams();
        params.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        params.append(&#34;Wjsy_lq&#34;, &#34;每日签到&#34;);
        fetch(url, {
          method: &#34;POST&#34;, // 设置请求方法为POST
          body: params, // 设置请求体为转换后的JSON字符串
        })
          .then(() =&gt; {
            console.log(&#34;无尽深渊领取成功&#34;);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          }); // 打印任何错误
      });
    };

    const getSign = () =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let signUrl = &#34;/index.php?settingfl&#34;;
        let signParams = new URLSearchParams();
        signParams.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        signParams.append(&#34;qiandao&#34;, &#34;每日签到&#34;);
        fetch(signUrl, {
          method: &#34;POST&#34;, // 设置请求方法为POST
          body: signParams, // 设置请求体为转换后的JSON字符串
        })
          .then(() =&gt; {
            console.log(&#34;签到指令运行成功&#34;);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          }); // 打印任何错误
      });
    };

    const getVip = () =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let vipUrl = &#34;/index.php?settingvip&#34;;
        let vipParms = new URLSearchParams();
        vipParms.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        vipParms.append(&#34;vip_gomod3&#34;, &#34;领每日福利&#34;);
        fetch(vipUrl, {
          method: &#34;POST&#34;, // 设置请求方法为POST
          body: vipParms, // 设置请求体为转换后的JSON字符串
        })
          .then(() =&gt; {
            console.log(&#34;领取指令运行成功&#34;);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          }); // 打印任何错误
      });
    };

    const menuElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; .body_md.pbgb  div.row &gt; div:nth-child(4) &gt; div&#34;,
    );
    if (menuElement &amp;&amp; !document.querySelector(&#34;#sign&#34;)) {
      const buttonElement = document.createElement(&#34;input&#34;);
      buttonElement.type = &#34;button&#34;;
      buttonElement.className = &#34;button6&#34;;
      buttonElement.style = &#34;border-radius:5px;&#34;;
      buttonElement.value = &#34;一键领取&#34;;
      buttonElement.id = &#34;sign&#34;;
      buttonElement.onclick = () =&gt; {
        Promise.all([getVip(), getSign(), getWj()])
          .then(() =&gt; {
            alert(&#34;签到成功 &amp; 领VIP每日福利成功&#34;);
          })
          .catch(() =&gt; {
            alert(&#34;一键领取 执行失败&#34;);
          });
      };
      menuElement.appendChild(buttonElement);
    }
  };

  // 批量扫荡秘境
  const addBatchCleanBtn = () =&gt; {
    const batchCleanFun = (index) =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let url = &#34;/index.php?Active&#34;;
        let params = new FormData();
        params.append(`monster_battle_fb_a_${index + 1}`, &#34;全部扫荡&#34;);
        params.append(&#34;ajaxBattle&#34;, 1);
        fetch(url, {
          method: &#34;POST&#34;,
          // headers: {
          //     &#34;Content-Type&#34;: &#34;application/x-www-form-urlencoded&#34;
          // },
          body: params,
        })
          .then(() =&gt; {
            console.log(`每日第${index + 1}个秘境完成`);
            resolve();
          })
          .catch(() =&gt; {
            console.log(`每日第${index + 1}个秘境失败`);
            reject();
          });
      });
    };

    let title = document.querySelector(&#34;#ajaxHtmlShow  h4:nth-child(1)&#34;);
    if (
      title &amp;&amp;
      title.innerText.includes(&#34;天地棋局&#34;) &amp;&amp;
      !document.querySelector(&#34;#batchClean&#34;)
    ) {
      let button = document.createElement(&#34;button&#34;);
      button.className = &#34;button3&#34;;
      button.type = &#34;button&#34;;
      button.innerText = &#34;批量快速扫荡&#34;;
      button.id = &#34;batchClean&#34;;

      button.onclick = () =&gt; {
        Promise.all([0, 1, 2, 3, 4, 5, 6].map((i) =&gt; batchCleanFun(i)))
          .then(() =&gt; {
            alert(&#34;批量扫荡执行成功&#34;);
          })
          .catch(() =&gt; {
            alert(&#34;批量扫荡执行失败&#34;);
          });
      };

      title.appendChild(button);
    }
  };

  // 一键升级伙伴等级
  const addUpAllByPartner = () =&gt; {
    const upByPartner = (team, name) =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let url = &#34;/index.php?&#34; + team;
        let params = new FormData();
        params.append(`levelcharup`, &#34;一键升级&#34;);
        params.append(&#34;ajaxBattle&#34;, 1);
        fetch(url, {
          method: &#34;POST&#34;,
          // headers: {
          //     &#34;Content-Type&#34;: &#34;application/x-www-form-urlencoded&#34;
          // },
          body: params,
        })
          .then(() =&gt; {
            console.log(`${name} 一键升级成功`);
            resolve();
          })
          .catch((e) =&gt; {
            console.log(`${name} 一键升级失败: ${e}`);
            reject();
          });
      });
    };

    let title = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; h4&#34;,
    );
    let partners = document.querySelectorAll(&#34;.button_tz_get&#34;);
    let buttonGroup = document.querySelector(
      &#34;#ajaxHtmlShow div &gt; div.col-md-12.col-xs-12 &gt; div:nth-child(2)&#34;,
    );
    if (
      title &amp;&amp;
      title.innerText.includes(&#34;伙伴列表&#34;) &amp;&amp;
      partners.length &gt; 0 &amp;&amp;
      !document.querySelector(&#34;#upByPartner&#34;)
    ) {
      let button = document.createElement(&#34;input&#34;);
      button.className = &#34;button6&#34;;
      button.type = &#34;button&#34;;
      button.value = &#34;一键升级&#34;;
      button.id = &#34;upByPartner&#34;;

      button.onclick = () =&gt; {
        Promise.all(
          Array.from(partners).map((partner) =&gt;
            upByPartner(
              partner.name,
              partner.parentNode.parentNode.innerText.replace(/\n/, &#34; &#34;),
            ),
          ),
        )
          .then(() =&gt; alert(&#34;一键所有伙伴升级执行成功&#34;))
          .catch(() =&gt; alert(&#34;一键所有伙伴升级执行失败&#34;));
      };

      buttonGroup.appendChild(button);
    }
  };

  // 一键入队(天魔入侵)
  const addJoinToKill = () =&gt; {
    // 获取团队ID
    const getTeamId = (teamIndex) =&gt; {
      console.log(&#34;teamIndex&#34;, teamIndex);
      const regex = new RegExp(&#39;name=&#34;teamid&#34;\\svalue=&#34;(\\d+)&#34;&#39;, &#34;gm&#34;);
      const decoder = new TextDecoder(&#34;gbk&#34;);
      return new Promise((resolve, reject) =&gt; {
        // https://fml.alangge.com/index.php?Raidboss
        let url = &#34;/index.php?Raidboss&#34;;
        let params = new FormData();
        params.append(&#34;raidboss_team&#34;, teamIndex);
        params.append(&#34;ajaxBattle&#34;, 1);
        fetch(url, {
          method: &#34;POST&#34;,
          // headers: {
          //     &#34;Content-Type&#34;: &#34;application/x-www-form-urlencoded&#34;
          // },
          body: params,
        })
          .then((response) =&gt; {
            // 获取 reader
            const reader = response.body.getReader();

            // 读取数据
            return new Promise((resolve, reject) =&gt; {
              let texs = [];
              try {
                reader.read().then(function process({ done, value }) {
                  if (done) {
                    console.log(&#34;Stream finished&#34;);
                    return resolve(texs.join(&#34;&#34;));
                  }

                  let text = decoder.decode(value);
                  texs.push(text);
                  // console.log(&#39;Received data chunk&#39;, text);

                  // 读取下一段数据
                  return reader.read().then(process);
                });
              } catch (e) {
                reject(e);
              }
            });
          })
          .then((data) =&gt; {
            let result = regex.exec(data);
            if (result) {
              console.log(&#34;teamIndex&#34;, teamIndex, result[1]);
              resolve(result[1]);
            } else {
              reject();
            }
          })
          .catch(() =&gt; {
            reject();
          });
      });
    };

    const join = (teamid) =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let url = &#34;/index.php?Raidboss&#34;;
        let params = new FormData();
        params.append(`teamid`, teamid);
        params.append(&#34;jointeam&#34;, &#34;入队&#34;);
        fetch(url, {
          method: &#34;POST&#34;,
          // headers: {
          //     &#34;Content-Type&#34;: &#34;application/x-www-form-urlencoded&#34;
          // },
          body: params,
        })
          .then(() =&gt; {
            console.log(`加入 ${teamid} 成功`);
            resolve();
          })
          .catch((e) =&gt; {
            console.log(`加入 ${teamid} 失败: ${e}`);
            reject();
          });
      });
    };

    const title = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div.col-md-12.col-xs-12 &gt; h4.panel-title.col-md-12.col-xs-12&#34;,
    );
    if (
      title &amp;&amp;
      title.innerText.includes(&#34;天魔入侵&#34;) &amp;&amp;
      !document.querySelector(&#34;#joinToKill&#34;)
    ) {
      let button = document.createElement(&#34;input&#34;);
      button.className = &#34;button6&#34;;
      button.type = &#34;button&#34;;
      button.value = &#34;一键入队&#34;;
      button.id = &#34;joinToKill&#34;;

      button.onclick = () =&gt; {
        // 请输入4个团队序号
        let teamIndexs = prompt(&#34;请输入4个团队序号(25 26 27 28)&#34;).split(&#34; &#34;);
        // prompt(&#34;请输入4个团队序号&#34;).split(&#34; &#34;).forEach((i)=&gt;console.log(i))
        Promise.all(
          teamIndexs.map((i) =&gt; getTeamId(i).then((teamid) =&gt; join(teamid))),
        )
          .then(() =&gt; alert(&#34;一键入队执行成功&#34;))
          .catch(() =&gt; alert(&#34;一键入队执行失败&#34;));
      };

      title.appendChild(button);
    }
  };

  // 冥河鬼舫
  const addJoinGuifang = () =&gt; {
    const join = () =&gt; {
      return new Promise((resolve, reject) =&gt; {
        let url = &#34;/index.php?Worldboss&#34;;
        let parms = new URLSearchParams();
        parms.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        parms.append(&#34;signup&#34;, &#34;报名参加&#34;);
        fetch(url, {
          method: &#34;POST&#34;, // 设置请求方法为POST
          body: parms, // 设置请求体为转换后的JSON字符串
        })
          .then(() =&gt; {
            console.log(&#34;报名成功&#34;);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          }); // 打印任何错误
      });
    };

    const menuElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; .body_md.pbgb  div.row &gt; div:nth-child(4) &gt; div&#34;,
    );
    if (menuElement &amp;&amp; !document.querySelector(&#34;#joinGuifang&#34;)) {
      const buttonElement = document.createElement(&#34;input&#34;);
      buttonElement.type = &#34;button&#34;;
      buttonElement.className = &#34;button6&#34;;
      buttonElement.style = &#34;border-radius:5px;&#34;;
      buttonElement.value = &#34;一键报名&#34;;
      buttonElement.id = &#34;joinGuifang&#34;;
      buttonElement.onclick = () =&gt; {
        Promise.all([join()])
          .then(() =&gt; {
            alert(&#34;报名成功&#34;);
          })
          .catch(() =&gt; {
            alert(&#34;报名失败&#34;);
          });
      };
      menuElement.appendChild(buttonElement);
    }
  };

  // 一键开垦药田
  const addOneClickCultivate = () =&gt; {
    const cultivate = (count) =&gt; {
      return new Promise((resolve, reject) =&gt; {
        const url = &#34;/index.php?menu=dfbcy&#34;;
        const params = new URLSearchParams();
        params.append(&#34;xzkw&#34;, &#34;1&#34;);
        params.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        fetch(url, {
          method: &#34;POST&#34;,
          body: params,
        })
          .then(() =&gt; {
            console.log(`成功开垦第${count}块土地`);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          });
      });
    };

    const menuElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div &gt; div.col-md-12.col-xs-12&#34;,
    );
    const titleElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div &gt; h4:nth-child(1)&#34;,
    );

    if (
      titleElement &amp;&amp;
      titleElement.innerText.includes(&#34;灵植仓库&#34;) &amp;&amp;
      menuElement &amp;&amp;
      !document.querySelector(&#34;#oneClickCultivate&#34;)
    ) {
      const buttonElement = document.createElement(&#34;input&#34;);
      buttonElement.type = &#34;button&#34;;
      buttonElement.className = &#34;button3 submit&#34;;
      buttonElement.value = &#34;一键开垦&#34;;
      buttonElement.id = &#34;oneClickCultivate&#34;;
      buttonElement.onclick = () =&gt; {
        const count = prompt(&#34;请输入要开垦的土地数量&#34;);
        if (count) {
          for (let i = 1; i &lt;= count; i++) {
            cultivate(i);
          }
          alert(&#34;开垦命令执行完成&#34;);
        }
      };
      menuElement.insertBefore(buttonElement, menuElement.firstChild);
    }
  };

  // 一键升级药田
  const addUpgradeFarmland = () =&gt; {
    const upgradeFarmland = () =&gt; {
      return new Promise((resolve, reject) =&gt; {
        const url = &#34;/index.php?menu=dfbcy&#34;;
        const params = new URLSearchParams();
        params.append(&#34;ytsj&#34;, &#34;1&#34;);
        params.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        fetch(url, {
          method: &#34;POST&#34;,
          body: params,
        })
          .then(() =&gt; {
            console.log(&#34;药田升级成功&#34;);
            resolve();
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            reject();
          });
      });
    };

    const menuElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div &gt; div.col-md-12.col-xs-12&#34;,
    );
    const titleElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div &gt; h4:nth-child(1)&#34;,
    );

    if (
      titleElement &amp;&amp;
      titleElement.innerText.includes(&#34;灵植仓库&#34;) &amp;&amp;
      menuElement &amp;&amp;
      !document.querySelector(&#34;#oneClickUpgrade&#34;)
    ) {
      const buttonElement = document.createElement(&#34;input&#34;);
      buttonElement.type = &#34;button&#34;;
      buttonElement.className = &#34;button3 submit&#34;;
      buttonElement.value = &#34;一键升级药田&#34;;
      buttonElement.id = &#34;oneClickUpgrade&#34;;
      buttonElement.onclick = () =&gt; {
        const count = prompt(&#34;请输入要升级次数&#34;);
        if (count) {
          for (let i = 1; i &lt;= count; i++) {
            upgradeFarmland();
          }
          alert(&#34;药田升级命令执行完成&#34;);
        }
      };
      menuElement.insertBefore(buttonElement, menuElement.firstChild);
    }
  };

  const addRefineEquipmentButton = () =&gt; {
    const refineEquipment = (opt, j) =&gt; {
      if (j === undefined) j = 0;
      let i = opt.maxLen;
      let element = opt.element;

      return new Promise((resolve, reject) =&gt; {
        console.log(i, j);
        if (j &gt;= i) {
          console.log(&#34;强化指令执行结束&#34;);
          return resolve();
        }
        const url = &#34;/index.php?refine=1695440709893474&#34;;
        const params = new URLSearchParams();
        params.append(&#34;onekeyrefine&#34;, &#34;1&#34;);
        params.append(&#34;ajaxBattle&#34;, &#34;1&#34;);
        fetch(url, {
          method: &#34;POST&#34;,
          body: params,
        })
          .then(() =&gt; {
            console.log(&#34;强化成功&#34;);
            opt.success += 1;
            element.value = `已强化${j + 1}次[${opt.success}/${opt.fail}]`;
            if (j % opt.waitDetermine === 0) {
              opt.waitFun(opt.waitTime).then(() =&gt; {
                return resolve(refineEquipment(opt, j + 1)); // 返回一个Promise对象
              });
            } else {
              return resolve(refineEquipment(opt, j + 1)); // 返回一个Promise对象
            }
          })
          .catch((error) =&gt; {
            console.error(&#34;Error:&#34;, error);
            opt.fail += 1;
            element.value = `已强化${j + 1}次[${opt.success}/${opt.fail}]`;

            if (j % opt.waitDetermine === 0) {
              opt.waitFun(opt.waitTime).then(() =&gt; {
                return reject(refineEquipment(opt, j + 1)); // 返回一个Promise对象
              });
            } else {
              return reject(refineEquipment(opt, j + 1)); // 返回一个Promise对象
            }
          });
      });
    };
    const targetElement = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div.col-md-12.col-xs-12.lazydiv&#34;,
    );
    const h4Element = document.querySelector(
      &#34;#ajaxHtmlShow &gt; div.body_md.pbgb &gt; div &gt; div.col-md-12.col-xs-12.lazydiv &gt; h4&#34;,
    );

    if (
      h4Element &amp;&amp;
      h4Element.innerText.includes(&#34;装备强化&#34;) &amp;&amp;
      !document.querySelector(&#34;#oneClickRefine&#34;)
    ) {
      const buttonElement = document.createElement(&#34;input&#34;);
      buttonElement.type = &#34;button&#34;;
      buttonElement.className = &#34;button4&#34;;
      buttonElement.value = &#34;一键强化pro&#34;;
      buttonElement.style.marginTop = &#34;10px&#34;;
      buttonElement.id = &#34;oneClickRefine&#34;;
      buttonElement.style.width = &#34;unset&#34;;
      buttonElement.style.padding = &#34;0 10px&#34;;
      buttonElement.onclick = () =&gt; {
        const count = prompt(&#34;请输入要强化次数&#34;);
        if (count &amp;&amp; !isNaN(Number(count))) {
          const opt = {
            element: buttonElement,
            maxLen: Number(count),
            success: 0,
            fail: 0,
            waitFun: wait,
            waitDetermine: 30,
            waitTime: 2000,
          };
          refineEquipment(opt)
            .then(() =&gt; {
              buttonElement.value = &#34;一键强化pro【完成】&#34;;
            })
            .catch(() =&gt; {
              alert(&#34;强化指令运行失败&#34;);
            });
        }
      };
      targetElement.appendChild(buttonElement);
    }
  };

  setInterval(() =&gt; {
    addOneCloseButton();
    addOneSignButton();
    addBatchCleanBtn();
    addUpAllByPartner();
    addJoinToKill();
    addJoinGuifang();
    // addOneClickCultivate() // 已经开垦完了
    // addUpgradeFarmland() // 已经升级到100了
    addRefineEquipmentButton();
  }, 1000);
})();
</pre>
    </main>
  </div>

  <script>
    // 返回首页
    document.getElementById('backButton').addEventListener('click', () => {
      window.history.back();
    });
  </script>
</body>
</html>