<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Detail</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1>Script Detail</h1>
      <button id="backButton" class="back-button">← Back</button>
    </header>

    <main id="detailContent">
      <h2 id="detailTitle">Kimi 选择性删除历史会话</h2>

      
        <p><strong>namespace:</strong> </p>
      
        <p><strong>version:</strong> 1.3</p>
      
        <p><strong>description:</strong> 在 Kimi 聊天记录页面为每个会话添加单选框，并提供一个美观的删除按钮，实现选择性删除历史会话。</p>
      
        <p><strong>author:</strong> 六记</p>
      
        <p><strong>match:</strong> https://kimi.ai/*,https://kimi.ai/chat/*,https://kimi.moonshot.cn/*,https://kimi.moonshot.cn/chat/*</p>
      
        <p><strong>id:</strong> -f-d-e-9-b-6-8-2-3788-4c43-b99a-6b7b08e0ea2a</p>
      
        <p><strong>filePath:</strong> scripts/Kimi 选择性删除历史会话.user.js</p>
      
        <p><strong>downloadLink:</strong> https://raw.githubusercontent.com/ACG-Q/UserScript/main/scripts/Kimi 选择性删除历史会话.user.js</p>
      

      <p><strong>content:</strong></p>
      <pre>// ==UserScript==
// @name         Kimi 选择性删除历史会话
// @namespace
// @version      1.3
// @description  在 Kimi 聊天记录页面为每个会话添加单选框，并提供一个美观的删除按钮，实现选择性删除历史会话。
// @author       六记
// @match        https://kimi.ai/*
// @match        https://kimi.ai/chat/*
// @match        https://kimi.moonshot.cn/*
// @match        https://kimi.moonshot.cn/chat/*
// @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABhCAYAAAApxKSdAAAACXBIWXMAACE4AAAhOAFFljFgAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAUUSURBVHgB7Z29bhtHFIWPHQN2J7lKqnhYpYvpIukCbJEAKQJEegLReYFIT0DrCSI9QEDqCSIDaQIEIOukiJwyza5SJWlId3FFz+HuGmuSSw6p+dlZ3g84luhdUeI9M3fmziyXgBCUe/DHYY0Wj/tgWmjV42zFcWe4MIBBPNJ6qqW0uvAbXFvQgKzQK62bQhkaCIPc10q1Zi3XH1o/IG9cwUm0RogrgDY1KmLgHYX9DvyiBvDYI77XmiD+oLlQHw7hIDoCMBOt1U9w0BsU9mOAtaUUFk3oQoIfzAQFCf5dNMEdTFCQ4NtQih1NSIGgf3ibxOJt5UrAB1gNK72vIdjiI61HWr+YnNxDXK0rJiULsV65GJeiIescLSTTeobKSutiCuojX8kU3MBx4I3WeNVBBRl4fWiCyoB8v2JAAkk9PmDwT8sH1TEghRjgC27scCx41wO43KAg+ILxTvhNaUACwTc04Z0B30LwzTzm5Rjw3sgseIG1wGMawMBPIOQcqvzrNIMHOg9Q5KK953O90/rFC+BhJRH8PQZ+fu7SjC7HAIV95yu99vjlxfvBJx8nwHd6IfNJAkccOjHg6OgIs9lsra6vr2GTNE03/k7q8HAhyJ/2gM9O65/4kT7/mwEcoZwYsPQiV3BwcABb9Ho9KKU2njccDjGdLlxx+InBBPBAAR86ydRPaIC9SASi3+8bnXd+fr78nw8NJ39uDJjXAVFPP7dp/VmWLR9g6w6Huo/IOTk5MTpvZesn/93AiP/dXCwd9SyILT9Jko3n1bZ+8s8rGPGvoVHbEXcPMM39V1dX9Qd/19PPNxta959D4HUGF0RrAFs/8/8mxuPxXLUwtfx2WX+cxdivZ3DFA0SKldZPuPTAKrikbOlMOX+9zFu/Q2iAQoSY5H7mfeb/tXCT8MdneU9wNNCuQUXZA0ynnrUznyqOcrspUY4BJunHqPU3gOgMsNr6G0B0BpgUXrG0fhKVAaaF1/HxMWIhKgNMcj9Tz82Nk6rVGdav/tJ5eraJ0Wi01XPq1r/xOS8uLkJc6XYnRTMNXdf62eIvLy+jyftVghnQ7Xahe8FW59fBTRYOzosDNI1hJdz0lBQkBflkMBjMU5iL13pXRb8fYAJrB/a2db0oFHthAOEUliaYFHE+aaUBdZsvvFhApyM0idYZwOCvW4JmIWdSzPmidQaYrAGZ7iX4oFUGnJ2dGdUCTRqMozeANQCLsE6nA10JG/0Mx4KmDMbBCjEWR2yxu8LAM98vXelmCA2ovVLCI8EMYODWbpbvCXtTBzQVMSAwYkBgxIDAtNKAXWdGIRADAiMpKDA0IIMQikx6QGDEgMCIAYGRMSAsMgaEhgbcQgjFa+kBYZnIGBCWWzEgLPNBOJ6Fk/aR8Y5ZCvktKwX/PJZ7xoVjfs+4chYU11tK2sE85qUBLyH4Zh5z6QHhGPOf6r2j+TEbcgdFP2RaHX5TrYQlDflj5RXE5Q1cG/lWnhYpReUGKdUewGnRmhvnCJbgmxey8sHiZ8iwF3AsUBBckKHI/SWLq6HsBc8huML4DiK80D6WnBqLzN68UFCmopheYJOVYgcU5FOVbAVfYUcUZGoaLPglCtITdg2+tZUFBTFh2+ArWEYh/7z0WIIQSiM43lt5AWAmWhLHylN4QmkNEXfAbGqEQKsHSfHLYwiSq8AnaAAKeaW3D8VbijwNW5nh3IN9FPI/jnpaPKZi2/SfFuJu4W3x9RqWL+N5C+7ruKpBAgLkAAAAAElFTkSuQmCC
// ==/UserScript==

(function () {
  &#34;use strict&#34;;
  // 当前域名
  const host = location.host;

  /**
   *  添加单选框到历史会话
   */
  function addRadioButtonsToChatLinks() {
    const chatLinks = document.querySelectorAll(&#34;.history-chat&#34;);

    if (chatLinks.length === 0) {
      return;
    }

    chatLinks.forEach((link) =&gt; {
      if (link.querySelector(&#34;.chat-select-radio&#34;)) return; // 防止重复添加

      const radio = document.createElement(&#34;input&#34;);
      radio.title = &#34;选择想要删除的对话&#34;;
      radio.type = &#34;checkbox&#34;;
      radio.name = &#34;chat-select&#34;;
      radio.classList.add(&#34;chat-select-radio&#34;);

      const chatInfo = link.querySelector(&#34;.history-chat-info&#34;);
      if (chatInfo) {
        chatInfo.appendChild(radio);

        // 阻止点击单选框时触发 a 标签的跳转
        radio.addEventListener(&#34;click&#34;, function (event) {
          event.stopPropagation();
        });
      }
    });
  }

  /**
   * 删除选中的会话
   */
  async function deleteSelectedChats() {
    const selectedChats = document.querySelectorAll(
      &#34;.chat-select-radio:checked&#34;,
    );

    if (!selectedChats || selectedChats.length === 0) {
      alert(&#34;⚠️ 请选择要删除的会话！&#34;);
      return;
    }

    const chatIds = Array.from(selectedChats).map((selectedChat) =&gt;
      selectedChat
        .closest(&#34;.history-chat&#34;)
        .getAttribute(&#34;href&#34;)
        .split(&#34;/&#34;)
        .pop(),
    );

    if (!chatIds || chatIds.length === 0) {
      alert(&#34;❌ 未能获取会话 ID，删除失败！&#34;);
      return;
    }

    // 获取授权信息
    const authHeader = localStorage.getItem(&#34;access_token&#34;);
    if (!authHeader) {
      alert(&#34;⚠️ 无法获取授权信息，请确保已登录 Kimi&#34;);
      return;
    }

    const headers = {
      accept: &#34;application/json, text/plain, */*&#34;,
      authorization: `Bearer ${authHeader}`,
      &#34;x-msh-platform&#34;: &#34;web&#34;,
      &#34;x-language&#34;: &#34;zh-CN&#34;,
      origin: `https://${host}`,
      referer: `https://${host}/chat/empty`,
      &#34;user-agent&#34;: navigator.userAgent,
      dnt: &#34;1&#34;,
    };

    const createDeleteFetch = async (chatId, selectedChat) =&gt; {
      try {
        const response = await fetch(`https://${host}/api/chat/${chatId}`, {
          method: &#34;DELETE&#34;,
          headers: headers,
        });

        if (response.ok) {
          console.log(`✅ 成功删除会话 ID: ${chatId}`);
          selectedChat.closest(&#34;.history-chat&#34;).remove();
        } else {
          console.error(`❌ 删除失败，请重试！`);
        }
      } catch (error) {
        console.error(&#34;删除会话时发生错误:&#34;, error);
        // console.error(&#39;❌ 删除会话时出现问题，请检查网络或稍后再试。&#39;);
        throw error;
      }
    };

    const deletePromises = chatIds.map((chatId) =&gt; {
      const selectedChat = Array.from(selectedChats).find(
        (selectedChat) =&gt;
          selectedChat
            .closest(&#34;.history-chat&#34;)
            .getAttribute(&#34;href&#34;)
            .split(&#34;/&#34;)
            .pop() === chatId,
      );
      return createDeleteFetch(chatId, selectedChat);
    });

    // 等待所有删除操作完成
    await Promise.all(deletePromises).then(() =&gt;
      alert(`✅ 成功删除会话 IDs: ${chatIds.join(&#34;, &#34;)}`),
    );
  }

  /**
   * 创建并添加删除按钮
   */
  function createDeleteButton() {
    const existingButton = document.getElementById(&#34;delete-selected-chat-btn&#34;);
    if (existingButton) return; // 防止重复添加

    const button = document.createElement(&#34;button&#34;);
    button.id = &#34;delete-selected-chat-btn&#34;;
    button.textContent = &#34;🗑️ 删除选中的会话&#34;;
    button.style.position = &#34;fixed&#34;;
    button.style.bottom = &#34;30px&#34;; // 增加底部间距
    button.style.right = &#34;30px&#34;; // 增加右侧间距
    button.style.background = &#34;linear-gradient(145deg, #ff4d4f, #d9363e)&#34;; // 渐变背景
    button.style.color = &#34;white&#34;;
    button.style.border = &#34;none&#34;;
    button.style.padding = &#34;12px 18px&#34;;
    button.style.borderRadius = &#34;12px&#34;;
    button.style.fontSize = &#34;16px&#34;;
    button.style.fontWeight = &#34;bold&#34;;
    button.style.cursor = &#34;pointer&#34;;
    button.style.boxShadow = &#34;0 4px 8px rgba(0, 0, 0, 0.2)&#34;;
    button.style.transition = &#34;background 0.3s ease, transform 0.2s ease&#34;;
    button.style.zIndex = &#34;9999&#34;;
    button.style.display = &#34;none&#34;;

    button.onmouseover = () =&gt; {
      button.style.background = &#34;linear-gradient(145deg, #d9363e, #ff4d4f)&#34;;
      button.style.transform = &#34;scale(1.05)&#34;;
    };
    button.onmouseout = () =&gt; {
      button.style.background = &#34;linear-gradient(145deg, #ff4d4f, #d9363e)&#34;;
      button.style.transform = &#34;scale(1)&#34;;
    };

    button.addEventListener(&#34;click&#34;, deleteSelectedChats);
    document.body.appendChild(button);

    // 监听 history-modal-container 是否显示
    const observer = new MutationObserver(() =&gt; {
      const modals = document.getElementsByClassName(&#34;history-modal-container&#34;);
      if (
        modals &amp;&amp;
        modals.length &gt; 0 &amp;&amp;
        getComputedStyle(modals[0]).display !== &#34;none&#34;
      ) {
        button.style.display = &#34;block&#34;;
      } else {
        button.style.display = &#34;none&#34;;
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  /**
   * 页面加载时运行
   */
  function init() {
    addRadioButtonsToChatLinks();
    createDeleteButton();

    // 监听动态加载（适用于 AJAX 渲染）
    const observer = new MutationObserver(() =&gt; {
      addRadioButtonsToChatLinks();
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  // 延迟 1 秒初始化，确保页面加载完成
  setTimeout(init, 1000);
})();
</pre>
    </main>
  </div>

  <script>
    // 返回首页
    document.getElementById('backButton').addEventListener('click', () => {
      window.history.back();
    });
  </script>
</body>
</html>